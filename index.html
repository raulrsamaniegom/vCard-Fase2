<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarjeta Digital - Fase 2</title>
    <style>
        :root {
            --primary-color: #0a1e5e; 
            --secondary-color: #ffffff;
            --bg-color: #f4f4f9;
        }
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 450px;
            background-color: var(--secondary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding-bottom: 30px;
        }
        
        /* Estilos de la FOTO DE PERFIL */
        .header { padding: 0; background-color: white; text-align: center; }
        .profile-pic { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: cover; display: block; }
        .info-block {
            padding: 20px 20px 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            margin-top: -5px;
        }
        
        .name { font-size: 1.8rem; margin: 0; font-weight: bold; }
        .role { font-size: 1.1rem; opacity: 0.9; margin-top: 5px; }
        .company { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }
        
        .actions { padding: 25px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn {
            display: flex; align-items: center; justify-content: center; padding: 12px;
            border-radius: 10px; text-decoration: none; font-weight: bold; transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; grid-column: span 2; font-size: 1.1rem; }
        .btn-secondary { background-color: #e9ecef; color: var(--primary-color); }
        
        .section-title { padding: 0 20px; margin-bottom: 10px; color: var(--primary-color); font-weight: bold; }
        .links-list { list-style: none; padding: 0 20px; margin-bottom: 20px; }
        .links-list li { margin-bottom: 10px; }
        .link-item { display: flex; align-items: center; text-decoration: none; color: #333; padding: 10px; background-color: #f8f9fa; border-radius: 8px; }
        
        /* Estilos de la GALER√çA (Miniaturas) */
        .gallery {
            padding: 20px 20px 0 20px;
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 10px; margin-bottom: 10px; 
        }
        .gallery img {
            width: 100%; height: 120px; object-fit: cover; border-radius: 8px;
            cursor: pointer; transition: transform 0.2s;
            -webkit-tap-highlight-color: transparent; /* Quita el flash azul en Android/iOS */
        }
        .gallery img:active { transform: scale(0.95); }

        /* --- ESTILOS PARA EL MODAL (PANTALLA COMPLETA) --- */
        .modal {
            display: none; /* Importante: Oculto al inicio */
            position: fixed; 
            z-index: 9999; /* Z-index alt√≠simo para que nada lo tape */
            left: 0; top: 0;
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.95);
            align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            display: block;
            width: 100%;
            max-height: 90vh;
            object-fit: contain; /* Esto asegura que NO se corte */
            animation-name: zoom; animation-duration: 0.3s;
        }

        .close {
            position: absolute; top: 20px; right: 30px;
            color: #f1f1f1; font-size: 40px; font-weight: bold;
            cursor: pointer; z-index: 10000;
            background: rgba(0,0,0,0.5); /* Fondo para que se vea mejor la X */
            width: 50px; height: 50px;
            text-align: center; line-height: 50px; border-radius: 50%;
        }
        @keyframes zoom { from {transform:scale(0.8); opacity: 0;} to {transform:scale(1); opacity: 1;} }
    </style>
</head>
<body>
    <div class="container" id="loading">Cargando tarjeta...</div>
    <div class="container" id="card-content" style="display: none;">
        <header class="header">
            <img src="" alt="Foto de perfil" class="profile-pic" id="profile-img">
            <div class="info-block">
                <h1 class="name" id="profile-name">Nombre Apellido</h1>
                <p class="role" id="profile-role">Cargo</p>
                <p class="company" id="profile-company">Empresa</p>
            </div>
        </header>
        <section class="actions">
            <a href="#" class="btn btn-primary" id="btn-save">Guardar Contacto</a>
            <a href="#" class="btn btn-secondary" id="btn-call">Llamar</a>
            <a href="#" class="btn btn-secondary" id="btn-wa">WhatsApp</a>
            <a href="#" class="btn btn-secondary" id="btn-email" style="grid-column: span 2;">Enviar Correo</a>
        </section>
        <h3 class="section-title">Enlaces</h3>
        <ul class="links-list">
            <li><a href="#" class="link-item" id="link-web" target="_blank">üåê <span id="text-web">Sitio Web</span></a></li>
            <li><a href="#" class="link-item" id="link-insta" target="_blank">üì∏ <span id="text-insta">Instagram</span></a></li>
        </ul>
        <h3 class="section-title">Galer√≠a</h3>
        <div class="gallery" id="gallery-container">
            </div>
    </div>

    <div id="image-modal" class="modal" onclick="cerrarModal()">
        <span class="close">&times;</span>
        <img class="modal-content" id="img-expanded">
    </div>

    <script>
        // Declaramos variables globales para el modal
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('img-expanded');

        // Funci√≥n para cerrar el modal (se llama desde el HTML)
        function cerrarModal() {
            modal.style.display = "none";
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loadingDiv = document.getElementById('loading');
            const contentDiv = document.getElementById('card-content');
            
            // 1. Obtener ID
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id');

            if (!userId) { loadingDiv.textContent = 'Error: Falta ID.'; return; }

            // 2. Cargar Datos
            fetch('data.json')
                .then(response => { if (!response.ok) throw new Error('Error carga JSON'); return response.json(); })
                .then(data => {
                    const user = data.usuarios.find(u => u.id === userId);
                    const global = data.global;

                    if (!user) { loadingDiv.textContent = 'Usuario no encontrado.'; return; }

                    // 3. Rellenar Textos
                    document.title = `${user.nombre} - ${global.empresa}`;
                    document.getElementById('profile-img').src = user.foto;
                    document.getElementById('profile-name').textContent = user.nombre;
                    document.getElementById('profile-role').textContent = user.cargo;
                    document.getElementById('profile-company').textContent = global.empresa;
                    
                    document.getElementById('btn-call').href = `tel:${user.telefono}`;
                    document.getElementById('btn-wa').href = `https://wa.me/${user.whatsapp}`;
                    document.getElementById('btn-email').href = `mailto:${user.email}`;
                    document.getElementById('link-web').href = global.sitio_web;
                    document.getElementById('text-web').textContent = global.sitio_web_texto;
                    document.getElementById('link-insta').href = global.instagram_url;
                    document.getElementById('text-insta').textContent = global.instagram_usuario;

                    // 4. GALER√çA CON CLIC DIRECTO
                    const galleryContainer = document.getElementById('gallery-container');
                    global.galeria.forEach(imgSrc => {
                        const img = document.createElement('img');
                        img.src = imgSrc;
                        img.alt = "Imagen Galer√≠a";
                        
                        // EVENTO DE CLIC
                        img.onclick = function(e) {
                            e.stopPropagation(); // Evita conflictos
                            modal.style.display = "flex"; // Abrir ventana
                            modalImg.src = this.src; // Poner foto grande
                        };
                        
                        galleryContainer.appendChild(img);
                    });

                    // Bot√≥n Descarga
                    document.getElementById('btn-save').addEventListener('click', (e) => {
                        e.preventDefault(); downloadVCard(user, global);
                    });

                    loadingDiv.style.display = 'none'; contentDiv.style.display = 'block';
                })
                .catch(error => { loadingDiv.textContent = error.message; });
        });

        function downloadVCard(user, global) {
            const nameParts = user.nombre.split(' ');
            const firstName = nameParts[0];
            const lastName = nameParts.slice(1).join(' ') || '';
            const vcard = `BEGIN:VCARD
VERSION:3.0
N:${lastName};${firstName};;;
FN:${user.nombre}
ORG:${global.empresa}
TITLE:${user.cargo}
TEL;TYPE=CELL:${user.telefono}
EMAIL;TYPE=WORK:${user.email}
URL:${global.sitio_web}
X-SOCIALPROFILE;TYPE=instagram:${global.instagram_usuario}
END:VCARD`;
            const blob = new Blob([vcard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = `${user.nombre.replace(' ', '_')}.vcf`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
